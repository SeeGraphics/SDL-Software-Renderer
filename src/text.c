#include "text.h"
#include "render.h"
#include <stddef.h>

typedef struct {
  char c;
  u8 rows[7]; // 5-bit wide rows, top to bottom
} Glyph5x7;

static const Glyph5x7 FONT[] = {
    {'0', {0x0E, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0E}},
    {'1', {0x04, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x0E}},
    {'2', {0x0E, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1F}},
    {'3', {0x0E, 0x11, 0x01, 0x06, 0x01, 0x11, 0x0E}},
    {'4', {0x02, 0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02}},
    {'5', {0x1F, 0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E}},
    {'6', {0x06, 0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E}},
    {'7', {0x1F, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08}},
    {'8', {0x0E, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E}},
    {'9', {0x0E, 0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C}},
    {'F', {0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x10}},
    {'P', {0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10}},
    {'S', {0x0F, 0x10, 0x10, 0x0E, 0x01, 0x01, 0x1E}},
    {' ', {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
};

static const Glyph5x7 *lookup_glyph(char c) {
  for (size_t i = 0; i < sizeof(FONT) / sizeof(FONT[0]); i++) {
    if (FONT[i].c == c) {
      return &FONT[i];
    }
  }
  return &FONT[sizeof(FONT) / sizeof(FONT[0]) - 1]; // space
}

void draw_char(u32 *buffer, int w, v2i pos, char c, u32 color) {
  const Glyph5x7 *g = lookup_glyph(c);
  for (int y = 0; y < 7; y++) {
    u8 row = g->rows[y];
    for (int x = 0; x < 5; x++) {
      if (row & (1 << (4 - x))) {
        set_pixel(buffer, w, (v2i){pos.x + x, pos.y + y}, color);
      }
    }
  }
}

void draw_text(u32 *buffer, int w, v2i pos, const char *text, u32 color) {
  int x = pos.x;
  for (const char *p = text; *p; ++p) {
    draw_char(buffer, w, (v2i){x, pos.y}, *p, color);
    x += 6; // 5px glyph + 1px space
  }
}
